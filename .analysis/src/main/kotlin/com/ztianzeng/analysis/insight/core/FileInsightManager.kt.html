<article>
  <header>
    <h1>FileInsightManager 分析</h1>
    <p>项目级服务，负责将 IDE 中选择的文件组织成 Codex CLI 请求并回推洞察结果。</p>
  </header>
  <section data-block="summary">
    <h2>功能摘要</h2>
    <ul>
      <li>类定义：`FileInsightManager` 以 `@Service(Service.Level.PROJECT)` 注册，内部持有 `ContextCollector`、`CliInvocationBridge` 与 `InsightStorage` 等依赖，用于串联上下文收集、CLI 调用与结果存储链路。参见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="15" data-end-line="22">FileInsightManager.kt:15-22</a>。</li>
      <li>主要职责：公开 `requestInsight`，接收 `PsiFile` 并启动后台任务，逐步汇报进度、构造 `CodexRequest`，调用 CLI 后发布 `FileInsightResult`。参见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="24" data-end-line="56">FileInsightManager.kt:24-56</a>。</li>
      <li>输入输出：输入为目标 `PsiFile` 及可选 `requestId`，输出是通过消息总线广播的 `FileInsightResult` 或错误事件；方法本身无直接返回值。</li>
      <li>副作用：创建 `Task.Backgroundable`、读取项目上下文、执行外部 CLI、写入 `InsightStorage` 标记的目标目录，并在异常/取消时发送错误事件以及记录日志。参见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="24" data-end-line="67">FileInsightManager.kt:24-67</a>。</li>
    </ul>
  </section>
  <section data-block="call-relations">
    <h2>调用关系</h2>
    <ul>
      <li>调用方（IDE 动作）：`AnalyzeFileAction` 在用户点击菜单项后调用 `FileInsightManager.requestInsight`，用于分析当前编辑器文件。场景：主动触发分析；目的：提供入口菜单。见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/actions/AnalyzeFileAction.kt" data-line="13" data-end-line="24">AnalyzeFileAction.kt:13-24</a>。</li>
      <li>调用方（WebView 刷新）：`InsightWebviewBridge` 处理前端的 `insight:refresh` 请求并调用该服务，以便刷新已选择文件的分析。场景：前端面板重新计算；目的：保持 UI 与文件同步。见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/ui/InsightWebviewBridge.kt" data-line="67" data-end-line="104">InsightWebviewBridge.kt:67-104</a>。</li>
      <li>被调用依赖（ContextCollector）：用于根据 `PsiFile` 生成结构化上下文（路径、语言、邻居等），是构造 `CodexRequest` 的基础。见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="19" data-end-line="42">FileInsightManager.kt:19-42</a>。</li>
      <li>被调用依赖（InsightStorage）：根据虚拟文件解析最终 CLI 的工作目录/目标，确保命令在正确上下文执行。见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="47" data-end-line="49">FileInsightManager.kt:47-49</a>。</li>
      <li>被调用依赖（CliInvocationBridge）：包装 Codex CLI 调用，接收 `CodexRequest` 与 `ProgressIndicator`，返回 CLI 响应。见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="48" data-end-line="55">FileInsightManager.kt:48-55</a>。</li>
      <li>系统依赖（InsightTopics 消息总线）：在任务生命周期内推送 `onProgress`、`onResult`、`onError`，供 UI 订阅。见 <a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="27" data-end-line="66">FileInsightManager.kt:27-66</a>。</li>
    </ul>
  </section>
  <section data-block="core-code">
    <h2>核心代码</h2>
    <table>
      <thead>
        <tr>
          <th>逻辑块</th>
          <th>行号</th>
          <th>职责说明</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>初始化依赖与任务包装</td>
          <td><a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="19" data-end-line="26">FileInsightManager.kt:19-26</a></td>
          <td>在构造函数中缓存项目级服务，`requestInsight` 内部创建 `Task.Backgroundable`，为异步执行奠定基础。</td>
        </tr>
        <tr>
          <td>上下文收集与 CLI 调用</td>
          <td><a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="27" data-end-line="55">FileInsightManager.kt:27-55</a></td>
          <td>先广播“Collecting context”，通过 `ContextCollector` 组装 `CodexRequest`，随后解析 `virtualFile`、定位分析目录，调用 `CliInvocationBridge` 并更新进度。</td>
        </tr>
        <tr>
          <td>结果/错误回推</td>
          <td><a data-file-link="true" data-file="src/main/kotlin/com/ztianzeng/analysis/insight/core/FileInsightManager.kt" data-line="54" data-end-line="67">FileInsightManager.kt:54-67</a></td>
          <td>成功时将 CLI 响应包裹成 `FileInsightResult` 并广播；异常或取消时发送错误消息并记录日志，保障 UI 能收到状态。</td>
        </tr>
      </tbody>
    </table>
  </section>
  <section data-block="method-notes">
    <h2>方法注释</h2>
    <ul>
      <li><strong>requestInsight(psiFile: PsiFile, requestId: String = UUID.randomUUID().toString())</strong>：入口 API，输入是待分析的 PSI 文件及可选请求 ID，输出为异步消息（result/progress/error）；副作用包括调度后台任务、调用 CLI、通过消息总线广播状态。</li>
      <li><strong>Task.Backgroundable.run(indicator: ProgressIndicator)</strong>：内部匿名类覆盖方法，利用进度指示器串行执行“收集上下文→调用 CLI→推送结果”，过程中可能读取文件内容与 Git 信息。</li>
      <li><strong>Task.Backgroundable.onThrowable(error: Throwable)</strong>：捕获任务异常，记录日志并发送 `onError` 事件，副作用是写入日志系统及通知 UI。</li>
      <li><strong>Task.Backgroundable.onCancel()</strong>：任务被取消时向消息总线推送“Analysis cancelled”错误，确保前端结束加载状态。</li>
    </ul>
  </section>
  <section data-block="api-docs">
    <h2>API 文档</h2>
    <div>
      <p>名称: requestInsight</p>
      <p>描述: 启动后台分析指定 `PsiFile`，期间自动生成请求上下文、调用 Codex CLI 并通过消息总线推送进度/结果。</p>
      <p>参数:</p>
      <table>
        <thead>
          <tr>
            <th>参数名称</th>
            <th>参数类型</th>
            <th>是否必填</th>
            <th>默认值</th>
            <th>使用描述</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>psiFile</td>
            <td>PsiFile</td>
            <td>是</td>
            <td>无</td>
            <td>待分析的 IDE 文件上下文，提供路径、语言与内容。</td>
          </tr>
          <tr>
            <td>requestId</td>
            <td>String</td>
            <td>否</td>
            <td>随机 UUID</td>
            <td>覆盖默认 ID 以便调用方在多请求并行时追踪进度。</td>
          </tr>
        </tbody>
      </table>
      <p>使用示例:</p>
      <pre><code class="language-kotlin">val manager = project.getService(FileInsightManager::class.java)
val psiFile = e.getRequiredData(CommonDataKeys.PSI_FILE)
manager.requestInsight(psiFile)

// 自定义 requestId 以复用同一 UI 卡片
manager.requestInsight(psiFile, requestId = "file-${psiFile.virtualFile.path}")</code></pre>
    </div>
  </section>
  <footer>
    <p>信息基于仓库当前版本（git d0eaa36）中 Kotlin 源码与文档的静态阅读所得。</p>
  </footer>
</article>